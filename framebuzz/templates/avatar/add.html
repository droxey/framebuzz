{% extends "base.html" %}
{% load staticfiles compress avatar_tags activity_tags profile_tags %}

{% block page_classes %}content profiles edit{% endblock %}

{% block title %}Edit Profile{% endblock %}

{% block page_css %}
    {% compress css %}
        <link href="{% static 'framebuzz/profiles/stylesheets/screen.css' %}" media="screen, projection" rel="stylesheet" type="text/css">
    {% endcompress %}
    {% block extra_css %}{% endblock %}
{% endblock %}

{% block content_center %}
    {% with request.user as profile_user %}
        <div id="sidebar" class="col-xs-3">
            <div id="details-wrapper" class="row">
                <div class="col-xs-12 details-col">
                    <div id="user-avatar" class="row">
                        <a href="{% url 'profiles-home' profile_user.username %}" class="avatar filter" data-filter="*">
                            <img src="{% static 'framebuzz/profiles/img/blank.png' %}" data-src="{% avatar_url profile_user 295 %}" alt="" class="img-responsive lazy-load">
                            <noscript><img src="{% avatar_url profile_user 295 %}"></noscript>
                        </a>
                    </div>
                    {% if profile_user.uservideo_set.all|length > 0 %}
                        <div id="user-videos" class="row clearfix">
                            {% for uv in profile_user.uservideo_set.all|slice:":4" %}
                                <div class="vid col-xs-3 pull-left">
                                    <a class="thumbnail-link play-video" href="{% url 'profiles-share' profile_user.username uv.video.video_id %}">
                                        <img src="{% static 'framebuzz/profiles/img/blank.png' %}" data-src="https://i1.ytimg.com/vi/{{ uv.video.video_id }}/mqdefault.jpg" alt="{{ uv.video.title|title }}" class="img-responsive lazy-load">
                                        <noscript><img src="https://i1.ytimg.com/vi/{{ uv.video.video_id }}/mqdefault.jpg"></noscript>
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div id="user-display-name" class="row">
                        <div class="col-xs-12">
                            <h1>{{ profile_user|display_name }}</h1>
                        </div>
                    </div>
                </div>
            </div>
            <div id="user-details" class="row">
                <h2><strong>Change Avatar</strong> <i class="fa fa-play fa-flip-horizontal pull-right"></i></h2>
            </div>
        </div>
    {% endwith %}
    <div id="profile-content" class="col-xs-9">
        <div id="add-video" class="row">
            <p class="description">Upload a new avatar below.</p>
        </div>
        <div id="timeline" class="avatar-section row">
            <div class="col-xs-12">
                <p>Drag and drop an image in the space below, or click the button below to add an image from your computer. Picture files ending in .png, .jpg, and .jpeg are supported.</p>
                <div class="clearfix upload-here">
                    <i class="fa fa-upload fa-4x pull-left"></i>
                    <form id="upload-avatar-form" enctype="multipart/form-data" method="POST" action="{% url 'avatar_add' %}" class="clearfix">
                        {% csrf_token %}
                        <span class="btn btn-success fileinput-button">
                            <i class="icon-plus"></i> Choose Picture&hellip;
                            <input id="id_avatar" type="file" name="avatar">
                        </span>
                    </form>
                </div>
                <div id="files" class="files"></div>
                <div id="progress" class="progress">
                    <div class="progress-bar progress-bar-success"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block page_javascript %}
    {% compress js %}
        <script src="{% static 'framebuzz/profiles/vendor/jquery/ui/js/jquery-ui-1.10.3.custom.min.js' %}"></script>
        <script src="{% static 'framebuzz/profiles/vendor/jquery/fileupload/canvas-to-blob.min.js' %}"></script>
        <script src="{% static 'framebuzz/profiles/vendor/jquery/fileupload/load-image.min.js' %}"></script>
        <script src="{% static 'framebuzz/profiles/vendor/jquery/fileupload/jquery.iframe-transport.js' %}"></script>
        <script src="{% static 'framebuzz/profiles/vendor/jquery/fileupload/jquery.fileupload.js' %}"></script>
        <script src="{% static 'framebuzz/profiles/vendor/jquery/fileupload/jquery.fileupload-process.js' %}"></script>
        <script src="{% static 'framebuzz/profiles/vendor/jquery/fileupload/jquery.fileupload-image.js' %}"></script>
        <script src="{% static 'framebuzz/profiles/vendor/jquery/fileupload/jquery.fileupload-validate.js' %}"></script>
        <script type="text/javascript">
            $(document).ready(function() {
                var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
                var uploadButton = $('<button/>')
                    .addClass('btn btn-info')
                    .prop('disabled', true)
                    .text('Processing...')
                    .on('click', function () {
                        var $this = $(this),
                            data = $this.data();
                        $this
                            .off('click')
                            .removeClass('btn-info')
                            .addClass('btn-danger')
                            .text('Abort')
                            .on('click', function () {
                                $this.remove();
                                data.abort();
                            });
                        data.submit().always(function () {
                            $this.remove();
                        });
                    });

                $('#id_avatar').fileupload({
                    url: '{% url "avatar_add" %}',
                    dataType: 'json',
                    autoUpload: false,
                    acceptFileTypes: /(\.|\/)(jpe?g|png)$/i,
                    maxFileSize: 5000000, // 5 MB
                    // Enable image resizing, except for Android and Opera,
                    // which actually support image resizing, but fail to
                    // send Blob objects via XHR requests:
                    disableImageResize: /Android(?!.*Chrome)|Opera/
                        .test(window.navigator.userAgent),
                    previewMaxWidth: 100,
                    previewMaxHeight: 100,
                    previewCrop: true,
                    formData: { 'csrfmiddlewaretoken': csrfToken }
                }).on('fileuploadadd', function (e, data) {
                    data.context = $('<div/>').appendTo('#files');
                    $.each(data.files, function (index, file) {
                        var node = $('<p class="clearfix" />').append($('<span/>').text(file.name));
                        if (!index) {
                            node.append(uploadButton.clone(true).data(data));
                        }
                        node.appendTo(data.context);
                    });
                }).on('fileuploadprocessalways', function (e, data) {
                    var index = data.index,
                        file = data.files[index],
                        node = $(data.context.children()[index]);

                    if (file.preview) {
                        node.prepend(file.preview);
                    }
                    if (file.error) {
                        node.append('<br>').append($('<span class="text-danger"/>').text(file.error));
                    }
                    if (index + 1 === data.files.length) {
                        data.context.find('button').text('Upload').prop('disabled', !!data.files.error);
                    }
                }).on('fileuploadprogressall', function (e, data) {
                    var progress = parseInt(data.loaded / data.total * 100, 10);
                    $('#progress .progress-bar').css('width', progress + '%');
                }).on('fileuploaddone', function (e, data) {
                    $.each(data.result.files, function (index, file) {
                        if (file.url) {
                            var success = $('<span class="text-success"/>').text('Upload successful!');
                            $(data.context.children()[index]).append('<br>').append(success);

                            window.setTimeout(function() {
                                $.when($('button.md-close').trigger('click'))
                                 .then(function() {
                                    window.location.href = '{% url "profiles-home" request.user.username %}';
                                });
                            }, 2000);
                        } else if (file.error) {
                            var error = $('<span class="text-danger"/>').text(file.error);
                            $(data.context.children()[index]).append('<br>').append(error);
                        }
                    });
                }).on('fileuploadfail', function (e, data) {
                    $.each(data.files, function (index, file) {
                        var error = $('<span class="text-danger"/>').text('File upload failed.');
                        $(data.context.children()[index]).append('<br>').append(error);
                    });
                }).prop('disabled', !$.support.fileInput)
                    .parent().addClass($.support.fileInput ? undefined : 'disabled');
                });
        </script>
    {% endcompress %}
{% endblock %}